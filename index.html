<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Notary</title>
    <!-- <link rel="stylesheet" type="text/css" href="style.css"> -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">

    <style>
        .mdl-layout {
            align-items: center;
            justify-content: center;
        }
        .mdl-layout__content {
            padding: 24px;
            flex: none;
        }
        .mdl-dialog {
            width: 40%;
        }
        
    </style>

    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
</head>

<body>

    <div class="mdl-layout mdl-js-layout mdl-color--grey-100">
        <main class="mdl-layout__content">

            <div class="mdl-card mdl-shadow--6dp">
                <div class="mdl-card__title mdl-color--primary mdl-color-text--white">
                    <h2 class="mdl-card__title-text">Star Notary Contract</h2>
                </div>
                <div class="mdl-card__supporting-text">

                    <div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
                        <div class="mdl-tabs__tab-bar">
                            <a href="#claim-panel" class="mdl-tabs__tab is-active" id="tab-claim">Claim</a>
                            <a href="#search-panel" class="mdl-tabs__tab" id="tab-search">Search</a>
                        </div>

                        <div class="mdl-tabs__panel is-active" id="claim-panel">

                            <div class="mdl-grid">

                                <div class="mdl-cell mdl-cell--12-col">
                                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                        <input class="mdl-textfield__input" type="text" id="star-name">
                                        <label class="mdl-textfield__label" for="sample3">Star Name</label>
                                    </div>
                                </div>

                                <div class="mdl-cell mdl-cell--4-col">
                                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                        <input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?"
                                            id="star-dec">
                                        <label class="mdl-textfield__label" for="star-dec">Dec</label>
                                        <span class="mdl-textfield__error">Input is not a number!</span>
                                    </div>
                                </div>
                                <div class="mdl-cell mdl-cell--4-col">
                                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                        <input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?"
                                            id="star-mag">
                                        <label class="mdl-textfield__label" for="star-mag">Mag</label>
                                        <span class="mdl-textfield__error">Input is not a number!</span>
                                    </div>
                                </div>
                                <div class="mdl-cell mdl-cell--4-col">
                                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                        <input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?"
                                            id="star-cent">
                                        <label class="mdl-textfield__label" for="star-cent">Cent</label>
                                        <span class="mdl-textfield__error">Input is not a number!</span>
                                    </div>
                                </div>

                                <div class="mdl-cell mdl-cell--12-col">
                                    <div class="mdl-textfield mdl-js-textfield">
                                        <textarea class="mdl-textfield__input" type="text" rows="3" id="star-story"></textarea>
                                        <label class="mdl-textfield__label" for="star-story">Star Story</label>
                                    </div>
                                </div>

                                <div class="mdl-cell mdl-cell--12-col">
                                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                        <input class="mdl-textfield__input" type="text" id="token-id">
                                        <label class="mdl-textfield__label" for="token-id">Token ID</label>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="mdl-tabs__panel" id="search-panel">
                            <div style="min-height: 300px">
                                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                    <input class="mdl-textfield__input" type="text" id="token-id">
                                    <label class="mdl-textfield__label" for="token-id">Token ID</label>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="mdl-card__actions mdl-card--border">
                        <!-- MDL Progress Bar with Indeterminate Progress -->
                        <div id="starProgressBar" class="mdl-progress mdl-js-progress mdl-progress__indeterminate"></div>

                        <button class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" id="claim-button">
                            Claim Star
                        </button>
                        <button class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" id="search-button">
                            Search Star
                        </button>
                    </div>
                </div>
        </main>
    </div>

    <dialog class="mdl-dialog">
        <h3 class="mdl-dialog__title">Transaction TxHash</h3>
        <div class="mdl-dialog__content">
            <a id="dialogContentLink" target="_blank">  </a>
        </div>
        <div class="mdl-dialog__actions">
            <button type="button" class="mdl-button close">Close</button>
        </div>
    </dialog>

    <script>

        const checkEthereum = async () => {

            if (window.ethereum) {

                window.web3 = new Web3(ethereum);

                try {

                    // Request account access if needed
                    await ethereum.enable();

                    // The default (top) wallet account from a list of test accounts 
                    web3.eth.defaultAccount = web3.eth.accounts[0];

                } catch (error) {
                    console.log(error, "User denied account access...");
                }
            }
            else {
                console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
            }

        }

        const initializeContracts = () => {

            // The interface definition for your smart contract (the ABI) 
            var StarNotary = web3.eth.contract(
                [
                    {
                        "constant": true,
                        "inputs": [
                            {
                                "name": "interfaceId",
                                "type": "bytes4"
                            }
                        ],
                        "name": "supportsInterface",
                        "outputs": [
                            {
                                "name": "",
                                "type": "bool"
                            }
                        ],
                        "payable": false,
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "constant": true,
                        "inputs": [
                            {
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "name": "starsForSale",
                        "outputs": [
                            {
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "payable": false,
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "constant": true,
                        "inputs": [
                            {
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "getApproved",
                        "outputs": [
                            {
                                "name": "",
                                "type": "address"
                            }
                        ],
                        "payable": false,
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "constant": false,
                        "inputs": [
                            {
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "approve",
                        "outputs": [],
                        "payable": false,
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "constant": false,
                        "inputs": [
                            {
                                "name": "from",
                                "type": "address"
                            },
                            {
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "transferFrom",
                        "outputs": [],
                        "payable": false,
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "constant": false,
                        "inputs": [
                            {
                                "name": "from",
                                "type": "address"
                            },
                            {
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "safeTransferFrom",
                        "outputs": [],
                        "payable": false,
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "constant": true,
                        "inputs": [
                            {
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "ownerOf",
                        "outputs": [
                            {
                                "name": "",
                                "type": "address"
                            }
                        ],
                        "payable": false,
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "constant": true,
                        "inputs": [
                            {
                                "name": "owner",
                                "type": "address"
                            }
                        ],
                        "name": "balanceOf",
                        "outputs": [
                            {
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "payable": false,
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "constant": false,
                        "inputs": [
                            {
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "name": "approved",
                                "type": "bool"
                            }
                        ],
                        "name": "setApprovalForAll",
                        "outputs": [],
                        "payable": false,
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "constant": false,
                        "inputs": [
                            {
                                "name": "from",
                                "type": "address"
                            },
                            {
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "name": "tokenId",
                                "type": "uint256"
                            },
                            {
                                "name": "_data",
                                "type": "bytes"
                            }
                        ],
                        "name": "safeTransferFrom",
                        "outputs": [],
                        "payable": false,
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "constant": true,
                        "inputs": [
                            {
                                "name": "owner",
                                "type": "address"
                            },
                            {
                                "name": "operator",
                                "type": "address"
                            }
                        ],
                        "name": "isApprovedForAll",
                        "outputs": [
                            {
                                "name": "",
                                "type": "bool"
                            }
                        ],
                        "payable": false,
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "constant": true,
                        "inputs": [
                            {
                                "name": "",
                                "type": "bytes32"
                            }
                        ],
                        "name": "uniqueHashStar",
                        "outputs": [
                            {
                                "name": "",
                                "type": "bool"
                            }
                        ],
                        "payable": false,
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "anonymous": false,
                        "inputs": [
                            {
                                "indexed": true,
                                "name": "from",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "name": "to",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "Transfer",
                        "type": "event"
                    },
                    {
                        "anonymous": false,
                        "inputs": [
                            {
                                "indexed": true,
                                "name": "owner",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "name": "approved",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "name": "tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "Approval",
                        "type": "event"
                    },
                    {
                        "anonymous": false,
                        "inputs": [
                            {
                                "indexed": true,
                                "name": "owner",
                                "type": "address"
                            },
                            {
                                "indexed": true,
                                "name": "operator",
                                "type": "address"
                            },
                            {
                                "indexed": false,
                                "name": "approved",
                                "type": "bool"
                            }
                        ],
                        "name": "ApprovalForAll",
                        "type": "event"
                    },
                    {
                        "constant": true,
                        "inputs": [
                            {
                                "name": "_ra",
                                "type": "string"
                            },
                            {
                                "name": "_dec",
                                "type": "string"
                            },
                            {
                                "name": "_mag",
                                "type": "string"
                            }
                        ],
                        "name": "checkIfStarExist",
                        "outputs": [
                            {
                                "name": "",
                                "type": "bool"
                            }
                        ],
                        "payable": false,
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "constant": false,
                        "inputs": [
                            {
                                "name": "_name",
                                "type": "string"
                            },
                            {
                                "name": "_story",
                                "type": "string"
                            },
                            {
                                "name": "_ra",
                                "type": "string"
                            },
                            {
                                "name": "_dec",
                                "type": "string"
                            },
                            {
                                "name": "_mag",
                                "type": "string"
                            },
                            {
                                "name": "_tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "createStar",
                        "outputs": [
                            {
                                "name": "index",
                                "type": "uint256"
                            }
                        ],
                        "payable": false,
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "constant": false,
                        "inputs": [
                            {
                                "name": "_tokenId",
                                "type": "uint256"
                            },
                            {
                                "name": "_price",
                                "type": "uint256"
                            }
                        ],
                        "name": "putStarUpForSale",
                        "outputs": [],
                        "payable": false,
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "constant": false,
                        "inputs": [
                            {
                                "name": "_tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "buyStar",
                        "outputs": [],
                        "payable": true,
                        "stateMutability": "payable",
                        "type": "function"
                    },
                    {
                        "constant": false,
                        "inputs": [
                            {
                                "name": "_tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "mint",
                        "outputs": [],
                        "payable": false,
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "constant": true,
                        "inputs": [
                            {
                                "name": "_tokenId",
                                "type": "uint256"
                            }
                        ],
                        "name": "tokenIdToStarInfo",
                        "outputs": [
                            {
                                "name": "",
                                "type": "string"
                            },
                            {
                                "name": "",
                                "type": "string"
                            },
                            {
                                "name": "",
                                "type": "string"
                            },
                            {
                                "name": "",
                                "type": "string"
                            },
                            {
                                "name": "",
                                "type": "string"
                            }
                        ],
                        "payable": false,
                        "stateMutability": "view",
                        "type": "function"
                    }
                ]
            );

            // Grab the contract at specified deployed address with the interface defined by the ABI
            window.starNotary = StarNotary.at('0x711091aff43c11b31b79602094c6c0b7951e8c9d');
        }

        window.addEventListener('load', async () => {

            await checkEthereum();

            await initializeContracts();

            document.querySelector("#search-button").style.display = "none";
            document.querySelector("#starProgressBar").style.display = "none";

            document.querySelector("#tab-claim").addEventListener('click', () => {
                document.querySelector("#search-button").style.display = "none";
                document.querySelector("#claim-button").style.display = "block";
            });

            document.querySelector("#tab-search").addEventListener('click', () => {
                document.querySelector("#search-button").style.display = "block";
                document.querySelector("#claim-button").style.display = "none";
            })

            var dialog = document.querySelector('dialog');
            
            var showDialogButton = document.querySelector('#show-dialog');
            
            if (!dialog.showModal) {
                dialogPolyfill.registerDialog(dialog);
            }
            
            dialog.querySelector('.close').addEventListener('click', function () {
                dialog.close();
            });

            // Temp
            // dialog.showModal();

            document.getElementById("claim-button").addEventListener("click", () => {

                document.querySelector("#starProgressBar").style.display = "block";

                const name = document.getElementById('star-name').value
                const dec = document.getElementById('star-dec').value
                const mag = document.getElementById('star-mag').value
                const cent = document.getElementById('star-cent').value
                const story = document.getElementById('star-story').value
                const tokenId = parseInt(document.getElementById('token-id').value) || 0

                web3.eth.getAccounts(function (err, accounts) {

                    starNotary.createStar(name, story, cent, dec, mag, tokenId, { from: accounts[0] }, function (err, tx) {

                        document.querySelector("#starProgressBar").style.display = "none";

                        dialog.showModal();

                        const rinkebyUrl = `https://rinkeby.etherscan.io/tx/${tx}`;

                        const dialogLink = document.querySelector("#dialogContentLink");
                        
                        dialogLink.innerText = tx;
                        dialogLink.href = `${rinkebyUrl}`;

                        console.log(tx);
                    })
                })
            });
        });
    </script>
</body>

</html>